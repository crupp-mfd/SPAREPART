WITH TextLookup AS (
    SELECT TXID, TX60
    FROM (
        SELECT
            TXID,
            TX60,
            ROW_NUMBER() OVER (PARTITION BY TXID ORDER BY Timestamp DESC, LINO DESC) AS rn
        FROM MSYTXL
    ) t
    WHERE rn = 1
),
RawJoin AS (
    SELECT
        A.ATNR,
        A.ATID,
        CASE
            WHEN COALESCE(A.ATVA, '') <> '' THEN A.ATVA
            WHEN COALESCE(A.TXID, 0) > 0 THEN Txt.TX60
            ELSE CAST(A.ATVN AS VARCHAR(100))
        END AS Value,
        COALESCE(M.HISN, A.BANO) AS Final_SERN
    FROM MIATTR A
    LEFT JOIN TextLookup Txt ON A.TXID = Txt.TXID
    LEFT JOIN MROUHI M
        ON A.ITNO = M.ITNO
        AND A.BANO = M.SERN
        AND M.REDN = 0
        AND M.REMD = 0
),
RankedAttributes AS (
    SELECT
        Final_SERN,
        ATID,
        Value,
        ROW_NUMBER() OVER (PARTITION BY Final_SERN, ATID ORDER BY ATNR DESC) AS RowNum
    FROM RawJoin
    WHERE Final_SERN IS NOT NULL
),
PivotedData AS (
    SELECT
        REPLACE(REPLACE(Final_SERN, ' ', ''), '-', '') AS Clean_SERN,
        TRY(CAST(REPLACE(REPLACE(Final_SERN, ' ', ''), '-', '') AS BIGINT)) AS Clean_SERN_INT,
        MAX(CASE WHEN ATID = 'WG-UIC TYP' THEN Value END) AS "WG_UIC_TYP",
        MAX(CASE WHEN ATID = 'WG-AUSTAUSCHVER' THEN Value END) AS "WG_AUSTAUSCHVER",
        MAX(CASE WHEN ATID = 'WG-HALTER_CODE' THEN Value END) AS "WG_HALTER_CODE",
        MAX(CASE WHEN ATID = 'WG-ECM_CODE' THEN Value END) AS "WG_ECM_CODE",
        MAX(CASE WHEN ATID = 'WG-BAUREIHE' THEN Value END) AS "WG_BAUREIHE",
        MAX(CASE WHEN ATID = 'WG-EIGENTUEMER' THEN Value END) AS "WG_EIGENTUEMER",
        MAX(CASE WHEN ATID = 'WG-ABSTOS-AUFLA' THEN Value END) AS "WG_ABSTOS_AUFLA",
        MAX(CASE WHEN ATID = 'WG-ANZAHL_DREHG' THEN Value END) AS "WG_ANZAHL_DREHG",
        MAX(CASE WHEN ATID = 'WG-ANZ_ACHSEN' THEN Value END) AS "WG_ANZ_ACHSEN",
        MAX(CASE WHEN ATID = 'WG-BEGRENZPROFI' THEN Value END) AS "WG_BEGRENZPROFI",
        MAX(CASE WHEN ATID = 'WG-BOGENHALBMES' THEN Value END) AS "WG_BOGENHALBMES",
        MAX(CASE WHEN ATID = 'WG-DREHZAPFENAB' THEN Value END) AS "WG_DREHZAPFENAB",
        MAX(CASE WHEN ATID = 'WG-KNICKWINKEL<' THEN Value END) AS "WG_KNICKWINKEL_LT",
        MAX(CASE WHEN ATID = 'WG-LAENGEUEBPUF' THEN Value END) AS "WG_LAENGEUEBPUF",
        MAX(CASE WHEN ATID = 'WG-HOEH_LADKANT' THEN Value END) AS "WG_HOEH_LADKANT",
        MAX(CASE WHEN ATID = 'WG-KRUEMMHM_MIN' THEN Value END) AS "WG_KRUEMMHM_MIN",
        MAX(CASE WHEN ATID = 'WG-SPURWEITE' THEN Value END) AS "WG_SPURWEITE",
        MAX(CASE WHEN ATID = 'WG-TUNNELFAEHIG' THEN Value END) AS "WG_TUNNELFAEHIG",
        MAX(CASE WHEN ATID = 'WG-REVFRISTVERL' THEN Value END) AS "WG_REVFRISTVERL",
        MAX(CASE WHEN ATID = 'WG-REGIST_LAND' THEN Value END) AS "WG_REGIST_LAND",
        MAX(CASE WHEN ATID = 'WG-INBETRIEBNAHME' THEN Value END) AS "WG_INBETRIEBNAHME",
        MAX(CASE WHEN ATID = 'WG-ZUL_GES_GEWI' THEN Value END) AS "WG_ZUL_GES_GEWI",
        MAX(CASE WHEN ATID = 'WG-EIGENGEWICHT' THEN Value END) AS "WG_EIGENGEWICHT",
        MAX(CASE WHEN ATID = 'WG-ZUL_RS_LAST' THEN Value END) AS "WG_ZUL_RS_LAST",
        MAX(CASE WHEN ATID = 'WG-TEMPBER_MAX' THEN Value END) AS "WG_TEMPBER_MAX",
        MAX(CASE WHEN ATID = 'WG-TEMPBER_MIN' THEN Value END) AS "WG_TEMPBER_MIN",
        MAX(CASE WHEN ATID = 'WG-ZULASSSTELLE' THEN Value END) AS "WG_ZULASSSTELLE",
        MAX(CASE WHEN ATID = 'WG-ZULASSDATUM' THEN Value END) AS "WG_ZULASSDATUM",
        MAX(CASE WHEN ATID = 'WG-ZULASSREFNR' THEN Value END) AS "WG_ZULASSREFNR",
        MAX(CASE WHEN ATID = 'WG-ZULASSENDDAT' THEN Value END) AS "WG_ZULASSENDDAT",
        MAX(CASE WHEN ATID = 'WG-ZULAUSGESETZ' THEN Value END) AS "WG_ZULAUSGESETZ",
        MAX(CASE WHEN ATID = 'WG-ZULAUSDATUM' THEN Value END) AS "WG_ZULAUSDATUM",
        MAX(CASE WHEN ATID = 'WG-ECVERSTELLE' THEN Value END) AS "WG_ECVERSTELLE",
        MAX(CASE WHEN ATID = 'WG-ECVERDATUM' THEN Value END) AS "WG_ECVERDATUM",
        MAX(CASE WHEN ATID = 'WG-ECVERNR' THEN Value END) AS "WG_ECVERNR",
        MAX(CASE WHEN ATID = 'WG-ERATVREF' THEN Value END) AS "WG_ERATVREF",
        MAX(CASE WHEN ATID = 'WG-TSI_ZUS_ZERT' THEN Value END) AS "WG_TSI_ZUS_ZERT",
        MAX(CASE WHEN ATID = 'WG-ECMWECHSNEXT' THEN Value END) AS "WG_ECMWECHSNEXT",
        MAX(CASE WHEN ATID = 'WG-ECMWECHSDAT' THEN Value END) AS "WG_ECMWECHSDAT",
        MAX(CASE WHEN ATID = 'WG-HALTER_VORHE' THEN Value END) AS "WG_HALTER_VORHE",
        MAX(CASE WHEN ATID = 'WG-AUSSERBETRIE' THEN Value END) AS "WG_AUSSERBETRIE",
        MAX(CASE WHEN ATID = 'WG-AVVWAGEN' THEN Value END) AS "WG_AVVWAGEN",
        MAX(CASE WHEN ATID = 'WG-RSABSTINNEN' THEN Value END) AS "WG_RSABSTINNEN",
        MAX(CASE WHEN ATID = 'WG-VMAX' THEN Value END) AS "WG_VMAX",
        MAX(CASE WHEN ATID = 'WG-ENTGLEISDET' THEN Value END) AS "WG_ENTGLEISDET",
        MAX(CASE WHEN ATID = 'WG-FAEHRFAEHIG' THEN Value END) AS "WG_FAEHRFAEHIG",
        MAX(CASE WHEN ATID = 'WG-IHREGIME' THEN Value END) AS "WG_IHREGIME",
        MAX(CASE WHEN ATID = 'WG-WAGENNR_ALT' THEN Value END) AS "WG_WAGENNR_ALT",
        MAX(CASE WHEN ATID = 'WG-REVPERIODE' THEN Value END) AS "WG_REVPERIODE",
        MAX(CASE WHEN ATID = 'WG-DATLETZG4.0' THEN Value END) AS "WG_DATLETZG4_0",
        MAX(CASE WHEN ATID = 'WG-DATLETZG4.2' THEN Value END) AS "WG_DATLETZG4_2",
        MAX(CASE WHEN ATID = 'AS-A-100' THEN Value END) AS "AS_A_100",
        MAX(CASE WHEN ATID = 'AS-A-120' THEN Value END) AS "AS_A_120",
        MAX(CASE WHEN ATID = 'AS-B-100' THEN Value END) AS "AS_B_100",
        MAX(CASE WHEN ATID = 'AS-B-120' THEN Value END) AS "AS_B_120",
        MAX(CASE WHEN ATID = 'AS-B1-100' THEN Value END) AS "AS_B1_100",
        MAX(CASE WHEN ATID = 'AS-B1-120' THEN Value END) AS "AS_B1_120",
        MAX(CASE WHEN ATID = 'AS-B2-100' THEN Value END) AS "AS_B2_100",
        MAX(CASE WHEN ATID = 'AS-B2-120' THEN Value END) AS "AS_B2_120",
        MAX(CASE WHEN ATID = 'AS-C-100' THEN Value END) AS "AS_C_100",
        MAX(CASE WHEN ATID = 'AS-C-120' THEN Value END) AS "AS_C_120",
        MAX(CASE WHEN ATID = 'AS-C2-100' THEN Value END) AS "AS_C2_100",
        MAX(CASE WHEN ATID = 'AS-C2-120' THEN Value END) AS "AS_C2_120",
        MAX(CASE WHEN ATID = 'AS-C3-100' THEN Value END) AS "AS_C3_100",
        MAX(CASE WHEN ATID = 'AS-C3-120' THEN Value END) AS "AS_C3_120",
        MAX(CASE WHEN ATID = 'AS-C4-100' THEN Value END) AS "AS_C4_100",
        MAX(CASE WHEN ATID = 'AS-C4-120' THEN Value END) AS "AS_C4_120",
        MAX(CASE WHEN ATID = 'AS-D-100' THEN Value END) AS "AS_D_100",
        MAX(CASE WHEN ATID = 'AS-D-120' THEN Value END) AS "AS_D_120",
        MAX(CASE WHEN ATID = 'AS-D2-100' THEN Value END) AS "AS_D2_100",
        MAX(CASE WHEN ATID = 'AS-D2-120' THEN Value END) AS "AS_D2_120",
        MAX(CASE WHEN ATID = 'AS-D3-100' THEN Value END) AS "AS_D3_100",
        MAX(CASE WHEN ATID = 'AS-D3-120' THEN Value END) AS "AS_D3_120",
        MAX(CASE WHEN ATID = 'AS-D4-100' THEN Value END) AS "AS_D4_100",
        MAX(CASE WHEN ATID = 'AS-D4-120' THEN Value END) AS "AS_D4_120",
        MAX(CASE WHEN ATID = 'AS-E-100' THEN Value END) AS "AS_E_100",
        MAX(CASE WHEN ATID = 'AS-E4-100' THEN Value END) AS "AS_E4_100",
        MAX(CASE WHEN ATID = 'AS-E5-100' THEN Value END) AS "AS_E5_100",
        MAX(CASE WHEN ATID = 'AS-STERNE' THEN Value END) AS "AS_STERNE",
        MAX(CASE WHEN ATID = 'AB-LADELAENG_GE' THEN Value END) AS "AB_LADELAENG_GE",
        MAX(CASE WHEN ATID = 'AB_LOSEBESTTYP' THEN Value END) AS "AB_LOSEBESTTYP",
        MAX(CASE WHEN ATID = 'AB_LOSEBESTZAHL' THEN Value END) AS "AB_LOSEBESTZAHL",
        MAX(CASE WHEN ATID = 'AB-TRAGWAGENTYP' THEN Value END) AS "AB_TRAGWAGENTYP",
        MAX(CASE WHEN ATID = 'DG-RS_ABSTAND' THEN Value END) AS "DG_RS_ABSTAND",
        MAX(CASE WHEN ATID = 'DG-RS_NENNLKD' THEN Value END) AS "DG_RS_NENNLKD",
        MAX(CASE WHEN ATID = 'BR-BAUART' THEN Value END) AS "BR_BAUART",
        MAX(CASE WHEN ATID = 'BR-LASTABBREMSU' THEN Value END) AS "BR_LASTABBREMSU",
        MAX(CASE WHEN ATID = 'BR-MAX_BREMSGEW' THEN Value END) AS "BR_MAX_BREMSGEW",
        MAX(CASE WHEN ATID = 'BR-SBREMSKRAFTS' THEN Value END) AS "BR_SBREMSKRAFTS",
        MAX(CASE WHEN ATID = 'BR-SOHLEN_MATER' THEN Value END) AS "BR_SOHLEN_MATER",
        MAX(CASE WHEN ATID = 'BR-SOHLEN_BEZEI' THEN Value END) AS "BR_SOHLEN_BEZEI",
        MAX(CASE WHEN ATID = 'BR-ANZ_BREMSSOH' THEN Value END) AS "BR_ANZ_BREMSSOH",
        MAX(CASE WHEN ATID = 'BR-BREMSSO_DIM' THEN Value END) AS "BR_BREMSSO_DIM",
        MAX(CASE WHEN ATID = 'BR-HANDBRGEWI' THEN Value END) AS "BR_HANDBRGEWI",
        MAX(CASE WHEN ATID = 'BR-TYP_HANDBREM' THEN Value END) AS "BR_TYP_HANDBREM",
        MAX(CASE WHEN ATID = 'KU-BRUCHLAST' THEN Value END) AS "KU_BRUCHLAST",
        MAX(CASE WHEN ATID = 'PU-PUFFERKATEGO' THEN Value END) AS "PU_PUFFERKATEGO",
        MAX(CASE WHEN ATID = 'IT-CH' THEN Value END) AS "IT_CH",
        MAX(CASE WHEN ATID = 'IT-CH-DATUM' THEN Value END) AS "IT_CH_DATUM"
    FROM RankedAttributes
    WHERE RowNum = 1
    GROUP BY Final_SERN
),
UniqueWagons AS (
    SELECT
        A.SERN,
        A.ITNO,
        ROW_NUMBER() OVER (PARTITION BY A.SERN ORDER BY A.ITNO DESC) AS rn
    FROM MILOIN A
    LEFT JOIN MITMAS B ON A.ITNO = B.ITNO
    WHERE B.ITTY = '100'
      AND A.STAT = '20'
)
SELECT
    W.SERN AS "ERP_SERIENNUMMER",
    TRY(CAST(REPLACE(REPLACE(W.SERN, ' ', ''), '-', '') AS BIGINT)) AS "WAGEN_SERIENNUMMER",
    W.ITNO AS "WG_BAUREIHE",
    P."WG_UIC_TYP",
    P."WG_AUSTAUSCHVER",
    P."WG_HALTER_CODE",
    P."WG_ECM_CODE",
    P."WG_EIGENTUEMER",
    P."WG_ABSTOS_AUFLA",
    CAST(TRY(CAST(P."WG_ANZAHL_DREHG" AS DECIMAL(18, 6))) AS INT) AS "WG_ANZAHL_DREHG",
    CAST(TRY(CAST(P."WG_ANZ_ACHSEN" AS DECIMAL(18, 6))) AS INT) AS "WG_ANZ_ACHSEN",
    P."WG_BEGRENZPROFI",
    CAST(TRY(CAST(P."WG_BOGENHALBMES" AS DECIMAL(18, 6))) AS INT) AS "WG_BOGENHALBMES",
    CAST(TRY(CAST(P."WG_DREHZAPFENAB" AS DECIMAL(18, 6))) AS INT) AS "WG_DREHZAPFENAB",
    P."WG_KNICKWINKEL_LT",
    CAST(TRY(CAST(P."WG_LAENGEUEBPUF" AS DECIMAL(18, 6))) AS INT) AS "WG_LAENGEUEBPUF",
    CAST(TRY(CAST(P."WG_HOEH_LADKANT" AS DECIMAL(18, 6))) AS INT) AS "WG_HOEH_LADKANT",
    CAST(TRY(CAST(P."WG_KRUEMMHM_MIN" AS DECIMAL(18, 6))) AS INT) AS "WG_KRUEMMHM_MIN",
    CAST(TRY(CAST(P."WG_SPURWEITE" AS DECIMAL(18, 6))) AS INT) AS "WG_SPURWEITE",
    P."WG_TUNNELFAEHIG",
    CAST(TRY(CAST(P."WG_REVFRISTVERL" AS DECIMAL(18, 6))) AS INT) AS "WG_REVFRISTVERL",
    P."WG_REGIST_LAND",
    P."WG_INBETRIEBNAHME" AS "WG_INBETRIEBNAHME",
    P."WG_ZUL_GES_GEWI",
    CAST(TRY(CAST(P."WG_EIGENGEWICHT" AS DECIMAL(18, 6))) AS INT) AS "WG_EIGENGEWICHT",
    CAST(TRY(CAST(P."WG_ZUL_RS_LAST" AS DECIMAL(18, 1))) AS DECIMAL(18, 1)) AS "WG_ZUL_RS_LAST",
    CAST(TRY(CAST(P."WG_TEMPBER_MAX" AS DECIMAL(18, 6))) AS INT) AS "WG_TEMPBER_MAX",
    CAST(TRY(CAST(P."WG_TEMPBER_MIN" AS DECIMAL(18, 6))) AS INT) AS "WG_TEMPBER_MIN",
    P."WG_ZULASSSTELLE",
    P."WG_ZULASSDATUM" AS "WG_ZULASSDATUM",
    P."WG_ZULASSREFNR",
    P."WG_ZULASSENDDAT" AS "WG_ZULASSENDDAT",
    P."WG_ZULAUSGESETZ",
    P."WG_ZULAUSDATUM" AS "WG_ZULAUSDATUM",
    P."WG_ECVERSTELLE",
    P."WG_ECVERDATUM" AS "WG_ECVERDATUM",
    P."WG_ECVERNR",
    P."WG_ERATVREF",
    P."WG_TSI_ZUS_ZERT",
    P."WG_ECMWECHSNEXT",
    P."WG_ECMWECHSDAT" AS "WG_ECMWECHSDAT",
    P."WG_HALTER_VORHE",
    P."WG_AUSSERBETRIE",
    P."WG_AVVWAGEN",
    CAST(TRY(CAST(P."WG_RSABSTINNEN" AS DECIMAL(18, 6))) AS INT) AS "WG_RSABSTINNEN",
    CAST(TRY(CAST(P."WG_VMAX" AS DECIMAL(18, 6))) AS INT) AS "WG_VMAX",
    P."WG_ENTGLEISDET",
    P."WG_FAEHRFAEHIG",
    CAST(TRY(CAST(P."WG_REVPERIODE" AS DECIMAL(18, 6))) AS INT) AS "WG_REVPERIODE",
    REPLACE(REPLACE(P."WG_DATLETZG4_0", '-', ''), ' ', '') AS "WG_DATLETZG4_0",
    REPLACE(REPLACE(P."WG_DATLETZG4_2", '-', ''), ' ', '') AS "WG_DATLETZG4_2",
    P."WG_IHREGIME",
    P."WG_WAGENNR_ALT",
    CAST(P."AS_A_100" AS DECIMAL(18, 1)) AS "AS_A_100",
    CAST(P."AS_A_120" AS DECIMAL(18, 1)) AS "AS_A_120",
    CAST(P."AS_B_100" AS DECIMAL(18, 1)) AS "AS_B_100",
    CAST(P."AS_B_120" AS DECIMAL(18, 1)) AS "AS_B_120",
    CAST(P."AS_B1_100" AS DECIMAL(18, 1)) AS "AS_B1_100",
    CAST(P."AS_B1_120" AS DECIMAL(18, 1)) AS "AS_B1_120",
    CAST(P."AS_B2_100" AS DECIMAL(18, 1)) AS "AS_B2_100",
    CAST(P."AS_B2_120" AS DECIMAL(18, 1)) AS "AS_B2_120",
    CAST(P."AS_C_100" AS DECIMAL(18, 1)) AS "AS_C_100",
    CAST(P."AS_C_120" AS DECIMAL(18, 1)) AS "AS_C_120",
    CAST(P."AS_C2_100" AS DECIMAL(18, 1)) AS "AS_C2_100",
    CAST(P."AS_C2_120" AS DECIMAL(18, 1)) AS "AS_C2_120",
    CAST(P."AS_C3_100" AS DECIMAL(18, 1)) AS "AS_C3_100",
    CAST(P."AS_C3_120" AS DECIMAL(18, 1)) AS "AS_C3_120",
    CAST(P."AS_C4_100" AS DECIMAL(18, 1)) AS "AS_C4_100",
    CAST(P."AS_C4_120" AS DECIMAL(18, 1)) AS "AS_C4_120",
    CAST(P."AS_D_100" AS DECIMAL(18, 1)) AS "AS_D_100",
    CAST(P."AS_D_120" AS DECIMAL(18, 1)) AS "AS_D_120",
    CAST(P."AS_D2_100" AS DECIMAL(18, 1)) AS "AS_D2_100",
    CAST(P."AS_D2_120" AS DECIMAL(18, 1)) AS "AS_D2_120",
    CAST(P."AS_D3_100" AS DECIMAL(18, 1)) AS "AS_D3_100",
    CAST(P."AS_D3_120" AS DECIMAL(18, 1)) AS "AS_D3_120",
    CAST(P."AS_D4_100" AS DECIMAL(18, 1)) AS "AS_D4_100",
    CAST(P."AS_D4_120" AS DECIMAL(18, 1)) AS "AS_D4_120",
    CAST(P."AS_E_100" AS DECIMAL(18, 1)) AS "AS_E_100",
    CAST(P."AS_E4_100" AS DECIMAL(18, 1)) AS "AS_E4_100",
    CAST(P."AS_E5_100" AS DECIMAL(18, 1)) AS "AS_E5_100",
    CAST(TRY(CAST(P."AS_STERNE" AS DECIMAL(18, 6))) AS INT) AS "AS_STERNE",
    CAST(TRY(CAST(P."AB_LADELAENG_GE" AS DECIMAL(18, 6))) AS INT) AS "AB_LADELAENG_GE",
    P."AB_LOSEBESTTYP",
    CAST(TRY(CAST(P."AB_LOSEBESTZAHL" AS DECIMAL(18, 6))) AS INT) AS "AB_LOSEBESTZAHL",
    P."AB_TRAGWAGENTYP",
    CAST(P."DG_RS_ABSTAND" AS DECIMAL(18, 1)) AS "DG_RS_ABSTAND",
    CAST(TRY(CAST(P."DG_RS_NENNLKD" AS DECIMAL(18, 6))) AS INT) AS "DG_RS_NENNLKD",
    P."BR_BAUART",
    P."BR_LASTABBREMSU",
    CAST(TRY(CAST(P."BR_MAX_BREMSGEW" AS DECIMAL(18, 6))) AS INT) AS "BR_MAX_BREMSGEW",
    P."BR_SBREMSKRAFTS",
    P."BR_SOHLEN_MATER",
    P."BR_SOHLEN_BEZEI",
    CAST(TRY(CAST(P."BR_ANZ_BREMSSOH" AS DECIMAL(18, 6))) AS INT) AS "BR_ANZ_BREMSSOH",
    CAST(TRY(CAST(P."BR_BREMSSO_DIM" AS DECIMAL(18, 6))) AS INT) AS "BR_BREMSSO_DIM",
    P."BR_HANDBRGEWI",
    P."BR_TYP_HANDBREM",
    CAST(TRY(CAST(P."KU_BRUCHLAST" AS DECIMAL(18, 6))) AS INT) AS "KU_BRUCHLAST",
    P."PU_PUFFERKATEGO",
    P."IT_CH",
    TRY(CAST(P."IT_CH_DATUM" AS DATE)) AS "IT_CH_DATUM",
    CURRENT_TIMESTAMP AS "TIMESTAMP",
    'N' AS "UPLOAD",
    NULL AS "TIME_UPLOAD"
FROM UniqueWagons W
LEFT JOIN PivotedData P
    ON TRY(CAST(REPLACE(REPLACE(W.SERN, ' ', ''), '-', '') AS BIGINT)) = P.Clean_SERN_INT
WHERE W.rn = 1;
